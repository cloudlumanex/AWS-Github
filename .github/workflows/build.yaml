name: Build to AWS ECR

on: push

jobs: 
  login-to-aws:
    runs-on: ubuntu-latest

    steps: 
      - name: Code Checkout
        uses: actions/checkout@v4
        
      - name: Login to AWS 
        uses: aws-actions/configure-aws-credentials@v4
        with: 
          registry: public.ecr.aws/b8y5c4r5
          user_name:: ${{ secrets.ACCESS_KEY }}
          password: ${{ secrets.SECRET_ACCESS_KEY }}
        env: 
          aws_region:  ${{ secrets.REGION }}
           

  Build-and-push-to-public-ECR:
    runs-on: ubuntu-latest
    needs:
      login-to-aws

    steps: 
      - name: Code Checkout
        uses: actions/checkout@v4
        
      - name: Login to AWS ECR
        uses: docker/login-action@v3
        with: 
          aws-access-key-id: ${{ secrets.ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.REGION }}
          

      - name: docker build
        run: |
          docker build -t awsgithubaction_api ..
          docker tag awsgithubaction_api:latest public.ecr.aws/b8y5c4r5/awsgithubaction_api:v1
          docker push public.ecr.aws/b8y5c4r5/awsgithubaction_api:v1
    
        
      
          
        
